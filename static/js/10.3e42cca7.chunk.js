(this["webpackJsonpall-in-one"]=this["webpackJsonpall-in-one"]||[]).push([[10],{769:function(e,t,i){"use strict";i.r(t),i.d(t,"commentsList",(function(){return r})),i.d(t,"commentAdded",(function(){return c})),i.d(t,"commentResolved",(function(){return l})),i.d(t,"commentUnResolved",(function(){return d})),i.d(t,"commentDeleted",(function(){return h})),i.d(t,"commentRestored",(function(){return u})),i.d(t,"replyAdded",(function(){return m})),i.d(t,"replyDeleted",(function(){return E})),i.d(t,"replyRestored",(function(){return v})),i.d(t,"commentResolvedAck",(function(){return T})),i.d(t,"commentDeletedAck",(function(){return p})),i.d(t,"replyDeletedAck",(function(){return S}));var n=i(160),a=i(65),o=i(22),s=i(82);const r=e=>t=>{t({type:s.a.COMMENTS_LIST,payload:{comments:e}})},c=e=>t=>{Object(n.b)(e,Object(o.e)(a.a.getState()))&&t({type:s.a.COMMENT_ADDED,payload:{comment:e}})},l=e=>t=>{t({type:s.a.COMMENT_RESOLVED,payload:e})},d=e=>t=>{t({type:s.a.COMMENT_UNRESOLVED,payload:e})},h=e=>t=>{t({type:s.a.COMMENT_DELETED,payload:e})},u=e=>t=>{t({type:s.a.COMMENT_RESTORED,payload:e})},m=e=>t=>{t({type:s.a.COMMENT_REPLY_ADDED,payload:e})},E=e=>t=>{t({type:s.a.COMMENT_REPLY_DELETED,payload:e})},v=e=>t=>{t({type:s.a.COMMENT_REPLY_RESTORED,payload:e})},T=e=>t=>{t({type:s.a.COMMENT_RESOLVED_ACK,payload:e})},p=e=>t=>{t({type:s.a.COMMENT_DELETED_ACK,payload:e})},S=e=>t=>{t({type:s.a.COMMENT_REPLY_DELETED_ACK,payload:e})}},858:function(e,t,i){"use strict";i.r(t);var n={};i.r(n),i.d(n,"updateStatus",(function(){return O})),i.d(n,"updateAuthStatus",(function(){return R}));var a=i(29),o=i(769),s=i(65),r=i(14),c=i(6),l=i(140),d=i(34),h=i(52),u=i(10),m=i(73),E=i(35),v=i(82),T=i(85),p=i(22),S=i(16),w=i(229),y=i(848),D=i(197);const O=e=>t=>{t({type:D.a.SET_WEBSOCKET_STATUS,payload:{status:e}})},R=e=>t=>{t({type:D.a.SET_AUTH_STATUS,payload:{isAuthenticated:e}})};class C{constructor(){this.socket=void 0,this.actions=void 0,this.handlers=[],this.socket=Object(y.a)("".concat(window.location.host),{path:"/io",transports:["websocket"],autoConnect:!1}),this.actions=Object(a.b)(n,s.a.dispatch),this.actions.updateStatus(D.b.ENABLED)}init(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"".concat(window.location.host);this.socket.connected||(this.socket.io.uri=e,this.initListeners(),this.socket.connect())}initListeners(){this.socket.on("connect",async()=>{this.actions.updateStatus(D.b.CONNECTED)}),this.socket.on("disconnect",()=>{this.actions.updateStatus(D.b.DISCONNECTED)}),this.socket.on("connect_error",e=>{this.actions.updateStatus(D.b.CONNECTION_ERROR)}),this.socket.on("reconnect_error",e=>{this.actions.updateStatus(D.b.CONNECTION_ERROR)}),this.socket.on("reconnect_failed",e=>{this.actions.updateStatus(D.b.CONNECTION_ERROR)}),this.socket.on("SOCKET_INIT_STATUS",e=>{this.actions.updateAuthStatus("success"===e.status)})}setSocketEventListeners(e){e.forEach(e=>{this.handlers.push(e),this.socket.on(e.name,e.instance)})}disconnect(){this.removeSocketEventListeners(),this.socket.close()}removeSocketEventListeners(){this.handlers.forEach(e=>{this.socket.off(e.name,e.instance)})}}const k=new class{constructor(){this.webSockets=new Map}init(e,t){const i=this.webSockets.get(t);i&&!i.socket.connected&&i.init(e)}getSocketInstance(e){let t=this.webSockets.get(e);return t||(t=new C,this.webSockets.set(e,t)),t}setSocketEventListeners(e,t,i,n){const a=this.getSocketInstance(e);a.setSocketEventListeners(i),a.socket.on("connect",()=>{a.socket.emit("initialize",t,{},n)}),a.socket.on("reconnect",()=>{"review"===e&&c.a.emit(c.b.COMMENTS_LIST),a.socket.emit("initialize",t,{},n)})}disconnect(e){const t=this.webSockets.get(e);null===t||void 0===t||t.disconnect()}};var I=i(47);var _=new class{constructor(){this.eventHandler=void 0,this.actions=void 0,this.socketHandlers=[],this.courseId=void 0,this.courseId=Object(r.i)(s.a.getState()),this.initWebSocketHandlers()}initWebSocketHandlers(){this.socketHandlers=[{name:"SOCKET_PASSWORD_UPDATED",instance:async()=>{await c.a.emit(c.b.DELETE_PASSWORD_COOKIE,{courseId:this.courseId,isSocketEvent:!0,shouldDelayReload:!0})}},{name:"SOCKET_PASSWORD_ADDED",instance:async()=>{await c.a.emit(c.b.PAGE_RELOAD)}},{name:"SOCKET_PASSWORD_TOGGLED",instance:async e=>{e.action===m.f&&await c.a.emit(c.b.PAGE_RELOAD)}},{name:"SOCKET_REVIEWER_REMOVED",instance:async e=>{var t;e.reviewer.id===(null===(t=Object(p.h)(s.a.getState()))||void 0===t?void 0:t.userId)&&await c.a.emit(c.b.DELETE_PASSWORD_COOKIE,{courseId:this.courseId,isSocketEvent:!0})}}]}};var g=new class{constructor(){this.token="",this.courseId="",this.reviewApiUrl="",this.authServiceUrl="",this.mediaServiceUrl="",this.authoringToolDomain="",this.reviewCommentContextUrl="",this.tokenServiceUrl="",this.shortKeys={i:"identifier",t:"shortType",cid:"commentId",r:"isReply"},this.initToken=async()=>{await this.getReviewTokenFromAuthService()},this.getUserDetails=()=>Object(p.h)(s.a.getState())}async initialize(e){let t=e.reviewApiUrl,i=e.authServiceUrl,n=e.mediaServiceUrl,a=e.courseId,o=e.authoringToolDomain,s=e.tokenServiceUrl,r=e.reviewCommentContextUrl;this.reviewApiUrl=t,this.authServiceUrl=i,this.mediaServiceUrl=n,this.courseId=a,this.authoringToolDomain=o,this.tokenServiceUrl=s,this.reviewCommentContextUrl=r,await this.initToken(),this.initTokenWebSocketHandlers(),this.getMediaTokenFromMediaService(),this.reviewCommentContextUrl&&this.extractScrollToParams()}initTokenWebSocketHandlers(){k.setSocketEventListeners(m.x.TOKEN,Object(I.a)(this.courseId),_.socketHandlers,this.token),k.init(this.tokenServiceUrl,m.x.TOKEN)}extractScrollToParams(){const e={identifier:"",shortType:"",commentId:""},t=this.parseQueryStringToObject(this.reviewCommentContextUrl);for(const n of Object.entries(t)){var i=Object(d.a)(n,2);const t=i[0],a=i[1],o=this.extractName(t);o&&(e[this.shortKeys[o]||o]=a)}this.getQuestionID(e),this.getSectionID(e),s.a.dispatch({type:E.a.REVIEW_COMMENT_REPLY,payload:{reviewCommentReply:e}})}extractName(e){return null===e||void 0===e?void 0:e.split("scr-")[1]}parseQueryStringToObject(e){const t=e.split("&"),i={};return t.forEach(e=>{const t=e.split("="),n=Object(d.a)(t,2),a=n[0],o=n[1];i[a]=o}),i}getQuestionID(e){const t=e.identifier,i=e.shortType;t.includes("lea")&&"int"===i||(t.includes("_")?e.questionId=t.split("_")[0]:e.questionId=t)}getSectionID(e){const t=e.questionId;Object(S.x)(s.a.getState(),t)&&(e.sectionId=Object(S.J)(s.a.getState(),t))}async getMediaTokenFromMediaService(){try{403===(await h.b.get("".concat(this.mediaServiceUrl,"/api/auth/token"),{credentials:"include",headers:{Authorization:"Bearer ".concat(this.token)},retryOptions:{retries:3,retryOn:[503]}})).status&&this.endSession()}catch(e){console.error(e)}}async getReviewTokenFromAuthService(){const e=await h.b.get("".concat(this.authServiceUrl,"/api/account/token"),{credentials:"include",query:{clientId:m.s},retryOptions:{retries:0,retryOn:[503]}});if(e.status<400||window.location.href.includes("localhost")&&localStorage.getItem(m.w)){const t=await e.json();if(this.token=null===t||void 0===t?void 0:t.token,await this.getUserInfoFromToken()===m.y)return c.a.emit(c.b.COMMENTS_LIST),!0}return!1}async registerReviewer(e){let t=e.name,i=e.email,n=e.avatarUrl,a=e.isVerified;try{const e=await h.b.post("".concat(this.reviewApiUrl,"reviewers"),{headers:{"Content-Type":u.f.JSON,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:this.token?"Bearer ".concat(this.token):void 0},query:{courseId:Object(I.a)(this.courseId)},data:{fullName:t,email:i,avatarUrl:n,isVerified:a}}),o=(await e.json()).id;s.a.dispatch({type:T.a.USER_AUTHENTICATED,payload:{name:t,email:i,avatarUrl:n,isRegisteredReviewer:!0,userId:o}})}catch(o){w.a.error(m.r,o)}}async updateReviewerName(e){let t=e.name;const i=await h.b.put("".concat(this.authServiceUrl,"/api/account/name"),{headers:{"Content-Type":u.f.JSON,Authorization:"Bearer ".concat(this.token)},data:{name:t},credentials:"include"});return 200!==i.status?(w.a.error(m.A,i),m.A):(s.a.dispatch({type:T.a.USER_AUTHENTICATED,payload:{name:t}}),m.y)}async endSession(){return window.navigator.onLine?(await h.b.post("".concat(this.authServiceUrl,"/api/account/logout"),{credentials:"include"}),await this.removePasswordCookie({courseId:Object(I.a)(this.courseId)}),m.y):m.k}async removePasswordCookie(e){let t=e.courseId,i=e.reload,n=e.shouldDelayReload;t=Object(I.a)(t),await h.b.get("".concat(this.tokenServiceUrl,"api/courses/").concat(t,"/end-session"),{credentials:"include"}),i&&this.reloadPage(n)}reloadPage(){arguments.length>0&&void 0!==arguments[0]&&arguments[0]?setTimeout(()=>{window.location.reload()},m.C):window.location.reload()}getCallbackUrl(){const e=window.location.pathname;return"https://".concat(this.authoringToolDomain,"/review/course").concat(e)}async updateUserEmail(e){let t=e.name,i=e.email;const n=this.getCallbackUrl();return window.navigator.onLine?200!==(await h.b.put("".concat(this.authServiceUrl,"/api/account/login-link"),{headers:{"Content-Type":u.f.JSON},query:{clientId:m.s},data:{email:i,fullName:t,callbackUrl:n}})).status?m.k:(s.a.dispatch({type:T.a.USER_AUTHENTICATED,payload:{name:t,email:i.newEmail}}),m.y):m.k}async getLoginLink(e){let t=e.name,i=e.email,n=e.avatarUrl,a=e.isIdentified;const o=window.navigator.onLine,r=this.getCallbackUrl();return o?200!==(await h.b.post("".concat(this.authServiceUrl,"/api/account/login-link"),{headers:{"Content-Type":u.f.JSON},query:{clientId:m.s},data:{email:i,fullName:t,callbackUrl:r}})).status?m.k:(s.a.dispatch({type:T.a.USER_AUTHENTICATED,payload:{name:t,email:i,avatarUrl:n,isRegisteredReviewer:a}}),m.y):m.k}async getUserInfoFromToken(){if(!window.navigator.onLine)return m.B;const e=await h.b.get("".concat(this.reviewApiUrl,"reviewers"),{headers:{"Content-Type":u.f.JSON,[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)}});if(404===e.status&&!window.location.href.includes("localhost"))return m.n;if(200!==e.status&&!window.location.href.includes("localhost"))return m.B;let t=await e.json(),i=t.fullName,n=t.email,a=t.avatarUrl,o=void 0===a?"":a;var r,c,l,d,v,p;window.location.href.includes("localhost")&&(this.token=null!==(r=null!==(c=this.token)&&void 0!==c?c:localStorage.getItem(m.w))&&void 0!==r?r:"",i=null!==(l=null!==(d=i)&&void 0!==d?d:localStorage.getItem("reviewerUsername"))&&void 0!==l?l:"",n=null!==(v=null!==(p=n)&&void 0!==p?p:localStorage.getItem("reviewerUsermail"))&&void 0!==v?v:"");return k.setSocketEventListeners(m.x.REVIEW,Object(I.a)(this.courseId),A.socketHandlers,this.token),k.init(this.reviewApiUrl,m.x.REVIEW),s.a.dispatch({type:T.a.USER_AUTHENTICATED,payload:{name:i,email:n,avatarUrl:o,isAuthenticatedReviewer:!0}}),this.registerReviewer({name:i,email:n,avatarUrl:o,isVerified:!0}),s.a.dispatch({type:E.a.UPDATE_REVIEW_LAYOUT,payload:{layout:m.j.ADD_COMMENT_WITH_HISTORY}}),m.y}async deleteCommentRequest(e){let t=e.commentId;const i=window.navigator.onLine,n=this.getUserDetails().name;return i?200!==(await h.b.delete("".concat(this.reviewApiUrl,"comments/").concat(t),{headers:{[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)},query:{fullName:n,isReviewer:!0}})).status?m.c:m.y:m.c}async deleteReplyRequest(e){let t=e.commentId,i=e.replyId;const n=window.navigator.onLine,a=this.getUserDetails().name;return n?200!==(await h.b.delete("".concat(this.reviewApiUrl,"comments/").concat(t,"/replies/").concat(i),{headers:{[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)},query:{fullName:a,isReviewer:!0}})).status?m.o:m.y:m.o}async ackDeletedRequest(e){let t=e.commentId,i=e.replyId;let n="";if(!window.navigator.onLine)return m.a;return i&&(n="replies/".concat(i,"/")),200!==(await h.b.post("".concat(this.reviewApiUrl,"comments/").concat(t,"/").concat(n,"acknowledge/delete"),{headers:{"Content-Type":u.f.JSON,[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)},data:{}})).status?m.a:m.y}async ackResolvedRequest(e){let t=e.commentId;return window.navigator.onLine?200!==(await h.b.post("".concat(this.reviewApiUrl,"comments/").concat(t,"/acknowledge/resolve"),{headers:{"Content-Type":u.f.JSON,[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)},data:{}})).status?m.a:m.y:m.a}async sendCommentReplyRequest(e){var t;let i=e.commentId,n=e.data;const a=window.navigator.onLine,o=this.getUserDetails(),s=o.name,r=o.email,c=o.avatarUrl;return a?(n.createdBy={avatarUrl:c,email:r,firstName:(null===s||void 0===s?void 0:null===(t=s.split(" "))||void 0===t?void 0:t[0])||"",lastName:(null===s||void 0===s?void 0:s.split(" ").splice(1).join(" "))||"",fullName:s||"",isReviewer:!0},201!==(await h.b.post("".concat(this.reviewApiUrl,"comments/").concat(i,"/replies"),{headers:{"Content-Type":u.f.JSON,[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)},data:n})).status?m.p:m.y):m.p}async sendCommentRequest(e){let t=e.data;const i=window.navigator.onLine,n=this.getUserDetails(),a=n.name,o=n.email;if(!i)return m.d;t.createdByName=a,t.fullName=a,t.createdBy=o,t.courseId=this.courseId;const r=await h.b.post("".concat(this.reviewApiUrl,"comments"),{headers:{"Content-Type":u.f.JSON,"X-Authoring-Tool-Domain":this.authoringToolDomain},data:t});if(200!==r.status)return m.d;const c={id:(await r.json()).id,text:t.text,mentionedEmails:[],deletedSeenEmails:[],resolvedSeenEmails:[],context:t.context,courseId:this.courseId,createdOn:new Date,createdBy:{fullName:a,email:o,isReviewer:!0},replies:[],isDeleted:!1,isResolved:!1};return s.a.dispatch({type:v.a.COMMENT_ADDED,payload:{comment:c}}),m.y}async getCommentsRequest(){if(!window.navigator.onLine)return m.b;const e=await h.b.get("".concat(this.reviewApiUrl,"comments/by-reviewer"),{headers:{"Content-Type":u.f.JSON,[m.h]:this.courseId,"X-Authoring-Tool-Domain":this.authoringToolDomain,Authorization:"Bearer ".concat(this.token)}});if(200!==e.status)return m.b;const t=await e.json();return s.a.dispatch({type:v.a.COMMENTS_LIST,payload:{comments:t}}),m.y}};class b extends l.a{constructor(){super(),this.handlers=void 0,this.handlers=[{event:c.b.REVIEW_INITIALIZED,instance:this.reviewInitialize.bind(this)},{event:c.b.COMMENT_SENT,instance:this.sendComment.bind(this)},{event:c.b.COMMENT_REPLY_SENT,instance:this.sendCommentReply.bind(this)},{event:c.b.COMMENT_DELETED,instance:this.deleteComment.bind(this)},{event:c.b.REPLY_DELETED,instance:this.deleteReply.bind(this)},{event:c.b.ACK_COMMENT_DELETED,instance:this.ackDeleted.bind(this)},{event:c.b.ACK_COMMENT_RESOLVED,instance:this.ackResolved.bind(this)},{event:c.b.ACK_REPLY_DELETED,instance:this.ackDeleted.bind(this)},{event:c.b.ACK_REPLY_RESOLVED,instance:this.ackResolved.bind(this)},{event:c.b.COMMENTS_LIST,instance:this.getComments.bind(this)},{event:c.b.END_REVIEWER_SESSION,instance:this.endSession.bind(this)},{event:c.b.GET_LOGIN_LINK,instance:this.getLoginLink.bind(this)},{event:c.b.REGISTER_REVIEWER,instance:this.registerReviewer.bind(this)},{event:c.b.UPDATE_REVIEWER_NAME,instance:this.updateReviewerName.bind(this)},{event:c.b.DELETE_PASSWORD_COOKIE,instance:this.removePasswordCookie.bind(this)},{event:c.b.PAGE_RELOAD,instance:this.reloadPage.bind(this)}]}reviewInitialize(e){let t=e.reviewApiUrl,i=e.authServiceUrl,n=e.mediaServiceUrl,a=e.courseId,o=e.authoringToolDomain,s=e.tokenServiceUrl,r=e.reviewCommentContextUrl;return g.initialize({reviewApiUrl:t,authServiceUrl:i,mediaServiceUrl:n,courseId:a,authoringToolDomain:o,tokenServiceUrl:s,reviewCommentContextUrl:r})}sendComment(e){let t=e.data;return g.sendCommentRequest({data:t})}sendCommentReply(e){let t=e.commentId,i=e.data;return g.sendCommentReplyRequest({commentId:t,data:i})}deleteComment(e){let t=e.commentId;return g.deleteCommentRequest({commentId:t})}deleteReply(e){let t=e.commentId,i=e.replyId;return g.deleteReplyRequest({commentId:t,replyId:i})}ackDeleted(e){let t=e.commentId,i=e.replyId;return g.ackDeletedRequest({commentId:t,replyId:i})}ackResolved(e){let t=e.commentId;return g.ackResolvedRequest({commentId:t})}getComments(){return g.getCommentsRequest()}getLoginLink(e){let t=e.name,i=e.email;return g.getLoginLink({name:t,email:i})}registerReviewer(e){let t=e.name,i=e.email,n=e.avatarUrl;return g.registerReviewer({name:t,email:i,avatarUrl:n})}updateReviewerName(e){return g.updateReviewerName({name:e})}endSession(){return g.endSession()}removePasswordCookie(e){let t=e.courseId,i=e.isSocketEvent,n=e.shouldDelayReload;return g.removePasswordCookie({courseId:t,reload:i,shouldDelayReload:n})}reloadPage(){return g.reloadPage(!0)}}var A=t.default=new class{constructor(){this.eventHandler=void 0,this.actions=void 0,this.socketHandlers=[],this.courseId=void 0,this.eventHandler=new b,this.actions=Object(a.b)(o,s.a.dispatch),this.courseId=Object(r.i)(s.a.getState()),this.initWebSocketHandlers()}subscribe(){this.eventHandler.on()}unsubscribe(){this.eventHandler.off()}initWebSocketHandlers(){this.socketHandlers=[{name:"SOCKET_COMMENT_ADDED",instance:e=>{this.actions.commentAdded(e)}},{name:"SOCKET_COMMENT_RESOLVED",instance:e=>{this.actions.commentResolved(e)}},{name:"SOCKET_COMMENT_UNRESOLVED",instance:e=>{this.actions.commentUnResolved(e)}},{name:"SOCKET_COMMENT_DELETED",instance:e=>{this.actions.commentDeleted(e)}},{name:"SOCKET_COMMENT_RESTORED",instance:e=>{this.actions.commentRestored(e)}},{name:"SOCKET_COMMENT_REPLY_ADDED",instance:e=>{this.actions.replyAdded(e)}},{name:"SOCKET_COMMENT_REPLY_DELETED",instance:e=>{this.actions.replyDeleted(e)}},{name:"SOCKET_COMMENT_REPLY_RESTORED",instance:e=>{this.actions.replyRestored(e)}},{name:"SOCKET_COMMENT_RESOLVED_ACK",instance:e=>{this.actions.commentResolvedAck(e)}},{name:"SOCKET_COMMENT_DELETED_ACK",instance:e=>{this.actions.commentDeletedAck(e)}},{name:"SOCKET_COMMENT_REPLY_DELETED_ACK",instance:e=>{this.actions.replyDeletedAck(e)}}]}}}}]);